class TaskRestart extends React.Component {
  static propTypes = {}

  state = {
    taskId: null,
    hidden: true,
    confirm: false,
    confirmMessage: null,
    restartFunction: null
  }

  componentDidMount() {
    const comp = this
    PubSub.subscribe('TASK_RESTART', function(message, data) {
      if (data.action === "show") {
        comp.setState({
          hidden: false,
          taskId: data.taskId
        })
      } else {
        comp.cancelRestart()
        comp.setState({ hidden: true })
      }
    })
  }

  confirmRestart(message, restartFunction) {
    this.setState({ confirm: true, confirmMessage: message, restartFunction: restartFunction })
  }

  cancelRestart() {
    this.setState({
      confirm: false,
      confirmMessage: null,
      restartFunction: null,
      error: false,
      errorMessage: null
    })
  }

  restart(continueInstance = false) {
    const comp = this
    $.ajax({
      url: "<%= Rails.application.routes.url_helpers.restart_flowy_instance_tasks_path %>",
      type: "POST",
      data: {
        id: comp.state.taskId,
        continue: continueInstance
      },
      headers: {
        token: "abc"
        // TODO: Change this
      },
      dataType: "json",
      success: function(data) {
        if (data.result === "error") {
          comp.setState({
            error: true,
            errorMessage: data.message
          })
        } else {
          location.reload()
        }
      },
      error: function(data) {
        if (data.status === 500) {
          comp.setState({
            error: true,
            errorMessage: data.statusText
          })
        } else {
          comp.setState({
            error: true,
            errorMessage: data.responseJSON.message
          })
        }
      }
    })
  }

  restartTaskOnly() {
    const comp = this
    this.confirmRestart("Are you sure you want to restart this task only?", function() {
      // Called if the user confirms restarting this task only
      comp.restart()
    })
  }

  restartInstanceFromHere() {
    const comp = this
    this.confirmRestart("Are you sure you want to restart the whole instance, starting from this task?", function() {
      // Called if the user confirms restarting the whole instance
      comp.restart(true)
    })
  }

  renderError() {
    if (this.state.error) {
      return (<div className="notification is-danger">Error: {this.state.errorMessage}</div>)
    }
    return null
  }

  render() {
    if (this.state.hidden) {
      return (<div />)
    }

    if (this.state.confirm) {
      return (
        <div>
          <p className="content">{this.state.confirmMessage}</p>
          <button onClick={this.state.restartFunction.bind(this)}>Yes</button>
          &nbsp;or&nbsp;
          <button onClick={this.cancelRestart.bind(this)}>Cancel</button>
          <br /><br />
          {this.renderError()}
        </div>
      )
    }

    return (
      <div>
        <p className="content">There are two ways to restart this task:</p>
        <p className="content">
          <button onClick={this.restartTaskOnly.bind(this)}>Restart this task only</button>
          &nbsp;or&nbsp;
          <button onClick={this.restartInstanceFromHere.bind(this)}>Restart the whole instance from here</button>
        </p>
        <p className="content">Press the appropriate button to continue, or cancel by closing this window.</p>
      </div>
    )
  }
}
